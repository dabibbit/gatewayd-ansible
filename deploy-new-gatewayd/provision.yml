---
- name: Spin up a new server on EC2
  hosts: 127.0.0.1
  connection: local
  tasks:
    - name: Create security group
      local_action:
        module: ec2_group
        name: gwd
        description: Access to anisble deployed gatewayd instances
        region: us-west-2
        rules:
          - proto: tcp
            from_port: 22
            to_port: 22
            cidir_ip: 0.0.0.0/0

    - name: Launch instance
      local_action:
        module: ec2
        instance_type: m3.medium
        key_name: ansible_gatewayd
        image: ami-29ebb519
        region: us-west-2
        wait: yes
        group: gwd
        count: 1
        assign_public_ip: yes
        vpc_subnet_id: subnet-93594ae7
      register: ec2

    - name: Add tag to instances
      local_action: ec2_tag resource={{ item.id }} region=us-west-2 state=present
      with_items: ec2.instances
      args:
        tags:
          Name: gwd

    - name: Wait for SSH to be available
      pause: minutes=1

- name: Configure new gatewayd
  hosts: gwd
  user: ubuntu
  sudo: True
  roles:
    - os
    - node-js
    - postgres
    - nginx
    - gatewayd